config firewall address
  edit "CORP_LAN"
    set allow-routing enable
    set subnet {{ globals.corp_aggregate }}
  next
end
config router static
  edit 101
    set dstaddr CORP_LAN
    set blackhole enable
    set comment "Avoid potential leak of corporate traffic to underlay"
  next
  edit 102
    set dst {{ globals.tunnel_subnet_aggregate }}
    set blackhole enable
    set comment "Avoid potential recursive resolution of corporate BGP routes via underlay"
  next
end

config router bgp
  set as {{ globals.as }}
  set router-id {{ devices[this_dev].router_id }}
  set keepalive-timer 5
  set holdtime-timer 15
  set ibgp-multipath enable
  set additional-path enable
  # additional-path-select = number of overlays
  set additional-path-select 4
  config neighbor-group
    edit "EDGE"
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path send
      # adv-additional-path = number of overlays
      set adv-additional-path 4
      set next-hop-self enable
      set route-reflector-client enable
    next
  end
  config neighbor-range
    edit 1
      set prefix {{ globals.tunnel_subnet_aggregate }}
      set neighbor-group "EDGE"
    next
  end
end

{# BEGIN: For multi-regional topology only #}
{% if regions|reject("==", devices[this_dev].region)|list|count -%}
config router static
  {% for reg in regions if reg != devices[this_dev].region -%}
  edit {{ loop.index * 4 + 102 }}
    set dst {{ regions[reg].t11_subnet }}
    set device "{{reg|upper}}_T11"
    set comment "Cross-region BGP NH reachability (T11)"
  next
  edit {{ loop.index * 4 + 103 }}
    set dst {{ regions[reg].t12_subnet }}
    set device "{{reg|upper}}_T12"
    set comment "Cross-region BGP NH reachability (T12)"
  next
  edit {{ loop.index * 4 + 104 }}
    set dst {{ regions[reg].t21_subnet }}
    set device "{{reg|upper}}_T21"
    set comment "Cross-region BGP NH reachability (T21)"
  next
  edit {{ loop.index * 4 + 105 }}
    set dst {{ regions[reg].t22_subnet }}
    set device "{{reg|upper}}_T22"
    set comment "Cross-region BGP NH reachability (T22)"
  next
  {% endfor -%}
end

# Use BGP communities to identify overlays
config router community-list
  edit "T11"
    config rule
      edit 1
        set action permit
        set match "{{ globals.as }}:11"
      next
    end
  next
  edit "T12"
    config rule
      edit 1
        set action permit
        set match "{{ globals.as }}:12"
      next
    end
  next
  edit "T21"
    config rule
      edit 1
        set action permit
        set match "{{ globals.as }}:21"
      next
    end
  next
  edit "T22"
    config rule
      edit 1
        set action permit
        set match "{{ globals.as }}:22"
      next
    end
  next
  edit "HUB"
    config rule
      edit 1
        set action permit
        set match "{{ globals.as }}:10"
      next
    end
  next
end
config router route-map
  # Avoid duplicate advertisement to remote regions
  edit "T11_OUT"
    config rule
      edit 1
        set match-community "T11"
        set action permit
      next
      edit 2
        set match-community "HUB"
        set set-community "{{ globals.as }}:11"
        set set-community-additive enable
      next
      edit 100
        set action deny
      next
    end
  next
  edit "T12_OUT"
    config rule
      edit 1
        set match-community "T12"
        set action permit
      next
      edit 2
        set match-community "HUB"
        set set-community "{{ globals.as }}:12"
        set set-community-additive enable
      next
      edit 100
        set action deny
      next
    end
  next
  edit "T21_OUT"
    config rule
      edit 1
        set match-community "T21"
        set action permit
      next
      edit 2
        set match-community "HUB"
        set set-community "{{ globals.as }}:21"
        set set-community-additive enable
      next
      edit 100
        set action deny
      next
    end
  next
  edit "T22_OUT"
    config rule
      edit 1
        set match-community "T22"
        set action permit
      next
      edit 2
        set match-community "HUB"
        set set-community "{{ globals.as }}:22"
        set set-community-additive enable
      next
      edit 100
        set action deny
      next
    end
  next
end

config router bgp
  config neighbor
    # Remote Regional Hubs
    {% for reg in regions if reg != devices[this_dev].region -%}
    edit {{ devices[this_dev].t11_remote_ip[reg] }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path both
      # adv-additional-path = number of overlays
      set adv-additional-path 4
      set next-hop-self enable
      set route-map-out "T11_OUT"
      set route-reflector-client enable
    next
    edit {{ devices[this_dev].t12_remote_ip[reg] }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path both
      # adv-additional-path = number of overlays
      set adv-additional-path 4
      set next-hop-self enable
      set route-map-out "T12_OUT"
      set route-reflector-client enable
    next
    edit {{ devices[this_dev].t21_remote_ip[reg] }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path both
      # adv-additional-path = number of overlays
      set adv-additional-path 4
      set next-hop-self enable
      set route-map-out "T21_OUT"
      set route-reflector-client enable
    next
    edit {{ devices[this_dev].t22_remote_ip[reg] }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path both
      # adv-additional-path = number of overlays
      set adv-additional-path 4
      set next-hop-self enable
      set route-map-out "T22_OUT"
      set route-reflector-client enable
    next
    {% endfor -%}
  end
end
{% endif %}
{# END: For multi-regional topology only #}
