{% set profile = profiles[devices[this_dev].profile] -%}
{% set hub_sla_members = [ ] -%}
config system sdwan
  set status enable
  config zone
    edit "virtual-wan-link"
    next
    edit "underlay"
    next
    edit "overlay"
    next
  end
  config members
    edit 1
      set interface {{ profile.wan1_intf }}
      set zone "underlay"
      # Best priority, used for Internet access in implicit rule / local-out
      # Gateway is fetched from DHCP
    next
    edit 2
      set interface {{ profile.wan2_intf }}
      set zone "underlay"
      # Best priority, used for Internet access in implicit rule / local-out
      # Gateway is fetched from DHCP
    next
    {%- for h in regions[devices[this_dev].region].hubs %}
    edit {{ loop.index * 4 }}
      set interface "H{{loop.index}}_T11"
      # Do not use for Internet access in implicit rule / local-out
      set priority 10
      set zone "overlay"
    next
    edit {{ loop.index * 4 + 1 }}
      set interface "H{{loop.index}}_T22"
      # Do not use for Internet access in implicit rule / local-out
      set priority 10
      set zone "overlay"
    next
    edit {{ loop.index * 4 + 2 }}
      set interface "H{{loop.index}}_T12"
      # Do not use for Internet access in implicit rule / local-out
      set priority 10
      set zone "overlay"
    next
    edit {{ loop.index * 4 + 3 }}
      set interface "H{{loop.index}}_T21"
      # Do not use for Internet access in implicit rule / local-out
      set priority 10
      set zone "overlay"
    next
    {{- hub_sla_members.append(loop.index * 4) or "" }}
    {{- hub_sla_members.append(loop.index * 4 + 1) or "" }}
    {{- hub_sla_members.append(loop.index * 4 + 2) or "" }}
    {{- hub_sla_members.append(loop.index * 4 + 3) or "" }}
    {%- endfor %}
  end
  config health-check
    edit "HUB"
      set server {{ globals.loopback_hc_ip }}
      set sla-fail-log-period 10
      set sla-pass-log-period 10
      set members {{ hub_sla_members|join(' ') }}
      config sla
        edit 1
          set link-cost-factor latency
          set latency-threshold 100
        next
      end
    next
    edit "Internet"
      set server "www.fortinet.com"
      set sla-fail-log-period 10
      set sla-pass-log-period 10
      set members 1 2
    next
  end
  config service
    {%- for h in regions[devices[this_dev].region].hubs %}
    edit {{loop.index}}
      set name "Corporate-H{{loop.index}}"
      set mode sla
      set dst "CORP_LAN"
      set src "CORP_LAN"
      set hold-down-time 20
      config sla
        edit "HUB"
          set id 1
        next
      end
      # Using Hub {{h}}
      set priority-members {{ loop.index * 4 }} {{ loop.index * 4 + 1 }} {{ loop.index * 4 + 2 }} {{ loop.index * 4 + 3 }}
    next
    {%- endfor %}
    edit 10
      set name "Local-Breakout"
      set mode priority
      set dst "all"
      set health-check Internet
      # Using best underlay (DIA) link
      set priority-members 1 2
    next
  end
end
config router static
  edit 100
    # Default route
    set sdwan enable
  next
end
