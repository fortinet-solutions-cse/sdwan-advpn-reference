{% set profile = profiles[devices[this_dev].profile] -%}
{% set reg_tunnels = [ ] -%}
config system settings
  # Allow overlay switchover for existing sessions (from shortcut to Hub)
  set tcp-session-without-syn enable
end
config system zone
  edit "overlay"
    {% for reg in regions if reg != devices[this_dev].region -%}
    {{ reg_tunnels.append('"' + reg|upper + '_T11' + '"') or "" -}}
    {{ reg_tunnels.append('"' + reg|upper + '_T12' + '"') or "" -}}
    {{ reg_tunnels.append('"' + reg|upper + '_T21' + '"') or "" -}}
    {{ reg_tunnels.append('"' + reg|upper + '_T22' + '"') or "" -}}
    {% endfor -%}
    set interface "EDGE_T11" "EDGE_T12" "EDGE_T21" "EDGE_T22" {{ reg_tunnels|join(' ') }}
  next
  edit "underlay"
    set interface "{{ profile.wan1_intf }}" "{{ profile.wan2_intf }}"
  next
end
config firewall service custom
  edit "PING"
    set category "Network Services"
    set protocol ICMP
    set icmptype 8
  next
end
config firewall policy
  edit 1
    set name "Edge to Edge"
    set srcintf "overlay"
    set dstintf "overlay"
    set srcaddr "all"
    set dstaddr "all"
    set action accept
    set schedule "always"
    set service "ALL"
    # Allow overlay switchover for existing sessions (from shortcut to Hub)
    set anti-replay disable
    set tcp-session-without-syn all
  next
  edit 2
    set name "Health-Check"
    set srcintf "overlay"
    set dstintf "lo-HC"
    set srcaddr "all"
    set dstaddr "all"
    set action accept
    set schedule "always"
    set service "PING"
  next
end
