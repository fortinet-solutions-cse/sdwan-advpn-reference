config firewall address
  edit "CORP_LAN"
    set allow-routing enable
    set subnet {{ globals.corp_aggregate }}
  next
end
config router static
  edit 101
    set dstaddr CORP_LAN
    set blackhole enable
    set comment "Avoid potential leak of corporate traffic to underlay"
  next
  {% for h in regions[devices[this_dev].region].hubs -%}
  edit {{ loop.index * 8 + 102 }}
    set dst {{ globals.t11_subnet_aggregate }}
    set device "H{{loop.index}}_T11"
    set comment "Cross-region BGP NH reachability (T11)"
  next
  edit {{ loop.index * 8 + 103 }}
    set dst {{ globals.t22_subnet_aggregate }}
    set device "H{{loop.index}}_T22"
    set comment "Cross-region BGP NH reachability (T22)"
  next
  edit {{ loop.index * 8 + 104 }}
    set dst {{ globals.t12_subnet_aggregate }}
    set device "H{{loop.index}}_T12"
    set comment "Cross-region BGP NH reachability (T12)"
  next
  edit {{ loop.index * 8 + 105 }}
    set dst {{ globals.t21_subnet_aggregate }}
    set device "H{{loop.index}}_T21"
    set comment "Cross-region BGP NH reachability (T21)"
  next
  edit {{ loop.index * 8 + 106 }}
    set dst {{ globals.tunnel_subnet_aggregate }}
    set device "H{{loop.index}}_T11"
    set comment "Cross-overlay BGP NH reachability"
  next
  edit {{ loop.index * 8 + 107 }}
    set dst {{ globals.tunnel_subnet_aggregate }}
    set device "H{{loop.index}}_T22"
    set comment "Cross-overlay BGP NH reachability"
  next
  edit {{ loop.index * 8 + 108 }}
    set dst {{ globals.tunnel_subnet_aggregate }}
    set device "H{{loop.index}}_T12"
    set comment "Cross-overlay BGP NH reachability"
  next
  edit {{ loop.index * 8 + 109 }}
    set dst {{ globals.tunnel_subnet_aggregate }}
    set device "H{{loop.index}}_T21"
    set comment "Cross-overlay BGP NH reachability"
  next
  {% endfor -%}
end

config router bgp
  set as {{ globals.as }}
  set router-id {{ devices[this_dev].router_id }}
  set keepalive-timer 5
  set holdtime-timer 15
  set ibgp-multipath enable
  set additional-path enable
  # additional-path-select = number of overlays
  set additional-path-select 2
  config neighbor
  {%- for h in regions[devices[this_dev].region].hubs %}
    edit {{ devices[h].t11_ip.edge }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set interface "H{{loop.index}}_T11"
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path receive
    next
    edit {{ devices[h].t12_ip.edge }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set interface "H{{loop.index}}_T12"
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path receive
    next
    edit {{ devices[h].t21_ip.edge }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set interface "H{{loop.index}}_T21"
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path receive
    next
    edit {{ devices[h].t22_ip.edge }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set interface "H{{loop.index}}_T22"
      set connect-timer 1
      set remote-as {{ globals.as }}
      set additional-path receive
    next
  {%- endfor %}
  end
  config network
    edit 1
      set prefix {{ devices[this_dev].lan_subnet }}
    next
  end
end
