{% import 'Globals' as globals with context %}

{% for h in globals.regions[region].hubs %}
{% set hubloop = loop %}
{% for i in globals.profiles[profile].interfaces if i.role == 'wan' %}
config vpn ipsec phase1-interface
  edit "H{{ hubloop.index }}_{{ i.ol_type }}"
    set interface "{{ i.name }}"
    set ike-version 2
    set authmethod signature
    set keylife 28800
    set peertype any
    set net-device enable
    set mode-cfg enable
    set proposal aes256-sha256
    set add-route disable
    set idle-timeout enable
    set auto-discovery-receiver enable
    set network-overlay enable
    set network-id {{ globals.hubs[h].overlays[i.ol_type].network_id }}
    set remote-gw {{ globals.hubs[h].overlays[i.ol_type].wan_ip }}
    set certificate "Edge"
    set dpd-retrycount 3
    set dpd-retryinterval 5
    set dpd on-idle
  next
end
config vpn ipsec phase2-interface
  edit "H{{ hubloop.index }}_{{ i.ol_type }}"
    set phase1name "H{{ hubloop.index }}_{{ i.ol_type }}"
    set proposal aes256-sha256
    set keepalive enable
    set keylifeseconds 3600
  next
end
config system interface
  edit "H{{ hubloop.index }}_{{ i.ol_type }}"
    set vdom "root"
    set allowaccess ping
    set type tunnel
    set interface "{{ i.name }}"
  next
end
{% endfor %}
{% endfor %}
