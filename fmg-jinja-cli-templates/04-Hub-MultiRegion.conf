{% import 'Globals' as globals with context %}

config system interface
  edit "lo-BGP"
    set vdom "root"
    set type loopback
    set ip {{ globals.hubs[hostname].lo_bgp }}/32
    set allowaccess ping
  next
end

{% set hub2hub_ol = [] %}
{% for i in globals.profiles[profile].interfaces if i.role == 'wan' %}
  {% for r in globals.regions if r != region %}
    {% for h in globals.regions[r].hubs %}
      {% if i.ol_type in globals.hubs[h].overlays %}
      config vpn ipsec phase1-interface
        edit "{{ r|upper }}_H{{ loop.index}}_{{ i.ol_type }}"
          set interface "{{ i.name }}"
          set ike-version 2
          set authmethod signature
          set keylife 28800
          set peertype any
          set proposal aes256-sha256
          set remote-gw {{ globals.hubs[h].overlays[i.ol_type].wan_ip }}
          set exchange-ip-addr4 {{ globals.hubs[hostname].lo_bgp }}
          set exchange-interface-ip enable
          set certificate "Hub"
          set dpd-retrycount 3
          set dpd-retryinterval 5
          set dpd on-idle
        next
      end
      config vpn ipsec phase2-interface
        edit "{{ r|upper }}_H{{ loop.index}}_{{ i.ol_type }}"
          set phase1name "{{ r|upper }}_H{{ loop.index}}_{{ i.ol_type }}"
          set proposal aes256-sha256
          set keepalive enable
          set keylifeseconds 3600
        next
      end
      config router policy
        edit {{ hub2hub_ol|length * 2 + 11 }}
          set input-device "EDGE_{{ i.ol_type }}"
          set output-device "{{ r|upper }}_H{{ loop.index}}_{{ i.ol_type }}"
          set dst {{ globals.lan_summary }}
        next
        edit {{ hub2hub_ol|length * 2 + 12 }}
          set input-device "{{ r|upper }}_H{{ loop.index}}_{{ i.ol_type }}"
          set output-device "EDGE_{{ i.ol_type }}"
          set dst {{ globals.lan_summary }}
        next
      end
      {{ hub2hub_ol.append(r|upper~'_H'~loop.index~'_'~i.ol_type) or "" }}
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}

config system zone
  edit hub2hub-overlay
    set interface {{ hub2hub_ol|join(' ') }}
  next
end

config router bgp
  config aggregate-address
    edit 1
      set prefix {{ globals.regions[region].lan_summary }}
    next
  end
end
config router access-list
  edit "REGION_SUMMARY"
    config rule
      edit 1
        set prefix {{ globals.regions[region].lan_summary }}
        set exact-match enable
      next
    end
  next
end
config router route-map
  edit "HUB2HUB_OUT"
    config rule
      edit 1
        set match-ip-address "REGION_SUMMARY"
      next
      edit 100
        set action deny
      next
    end
  next
end

config router bgp
  config neighbor
    {% for r in globals.regions if r != region %}
    {% for h in globals.regions[r].hubs %}
    edit {{ globals.hubs[h].lo_bgp }}
      set ebgp-enforce-multihop enable
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set interface "lo-BGP"
      set update-source "lo-BGP"
      set route-map-out "HUB2HUB_OUT"
      set connect-timer 1
      set remote-as {{ globals.regions[r].as }}
    next
    {% endfor %}
    {% endfor %}
  end
end
