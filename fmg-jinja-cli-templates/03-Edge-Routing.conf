{% import 'Globals' as globals with context %}

config router bgp
  set as {{ globals.regions[region].as }}
  set router-id {{ lan_ip|ipaddr('address') }}
  set keepalive-timer 5
  set holdtime-timer 15
  set ibgp-multipath enable
  set additional-path enable
  # additional-path-select = max. number of overlays * max. number of hubs
  set additional-path-select 6
  set recursive-next-hop enable
  config neighbor
    {% for h in globals.regions[region].hubs %}
    {% set hubloop = loop %}
    {% for i in globals.profiles[profile].interfaces if i.role == 'wan' %}
    edit {{ globals.hubs[h].overlays[i.ol_type].tunnel_net|ipaddr(1)|ipaddr('address') }}
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set interface "H{{ hubloop.index }}_{{ i.ol_type }}"
      set connect-timer 1
      set remote-as {{ globals.regions[region].as }}
      set additional-path receive
    next
    {% endfor %}
    {% endfor %}
  end
  config network
    {% for i in globals.profiles[profile].interfaces if i.role == 'lan' %}
    edit {{ loop.index }}
      set prefix {{ i.ip|ipaddr(0) }}
    next
    {% endfor %}
  end
end
