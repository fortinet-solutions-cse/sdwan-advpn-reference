{% import 'Globals' as globals with context %}

config router route-map
  edit "IBGP-ONLY"
    config rule
      edit 1
        # Do not advertise outside to EBGP peers (outside the SD-WAN region)
        set set-community "no-export"
      next
    end
  next
end
config router bgp
  set as {{ globals.regions[region].as }}
  set router-id {{ lan_ip|ipaddr(1)|ipaddr('address') }}
  set keepalive-timer 5
  set holdtime-timer 15
  set ibgp-multipath enable
  set ebgp-multipath enable
  set additional-path enable
  # additional-path-select = max. number of overlays * max. number of hubs
  set additional-path-select 6
  set recursive-next-hop enable
  config neighbor-group
    edit "EDGE"
      set soft-reconfiguration enable
      set advertisement-interval 1
      set link-down-failover enable
      set next-hop-self enable
      set remote-as {{ globals.regions[region].as }}
      set additional-path send
      # adv-additional-path = max. number of overlays * max. number of hubs
      set adv-additional-path 6
      set route-reflector-client enable
    next
  end
  config neighbor-range
    edit 1
      set prefix {{ globals.tunnel_summary }}
      set neighbor-group "EDGE"
    next
  end
  config network
    edit 1
      set prefix {{ globals.tunnel_summary }}
      set route-map "IBGP-ONLY"
    next
    {% for i in globals.profiles[profile].interfaces if i.role == 'lan' %}
    edit {{ loop.index + 1 }}
      set prefix {{ i.ip|ipaddr(0) }}
    next
    {% endfor %}
  end
end

config router policy
  {% for i in globals.profiles[profile].interfaces if i.role == 'wan' %}
  edit {{ loop.index }}
    set input-device "EDGE_{{ i.ol_type }}"
    set output-device "EDGE_{{ i.ol_type }}"
    set dst {{ globals.lan_summary }}
  next
  {% endfor %}
end

config router static
  edit 101
    set dst {{ globals.lan_summary }}
    set blackhole enable
    set comment "Avoid potential leak of corporate traffic to underlay"
  next
  edit 102
    set dst {{ globals.tunnel_summary }}
    set blackhole enable
    set comment "Avoid potential recursive resolution of corporate BGP routes via underlay"
  next
end
